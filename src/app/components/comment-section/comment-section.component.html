<div class="comments-container">
  <!-- Rating Summary Section - Always visible -->
  <ng-container *ngIf="ratingStats$ | async as stats">
    <div class="rating-summary">
      <div class="rating-left">
        <div class="average-score">{{ stats.total > 0 ? stats.average : '-' }}</div>
        <div class="average-stars">
          <!-- Display stars based on 10-point scale (approximate) -->
          <mat-icon *ngFor="let i of [1,2,3,4,5]" [class.filled]="i <= (stats.average / 2)">
            {{ i <= (stats.average / 2) ? 'star' : 'star_border' }}
          </mat-icon>
        </div>
        <div class="total-reviews">{{ stats.total }} Ratings</div>
      </div>
      <div class="rating-right">
        <div class="rating-bar" *ngFor="let percent of stats.distribution; let i = index">
          <span class="star-label">{{ 5 - i }}â˜…</span>
          <div class="bar-container">
            <div class="bar-fill" [style.width.%]="percent"></div>
          </div>
          <span class="percent-label">{{ stats.total > 0 ? (percent | number:'1.1-1') : '0' }}%</span>
        </div>
      </div>
    </div>

    <!-- Rate Now Section -->
    <div class="rate-now-section">
      <span class="rate-label">Rate Now</span>
      <div class="star-picker-inline">
        <mat-icon *ngFor="let i of [1,2,3,4,5]"
                  (click)="setRating(i)"
                  (mouseenter)="setHover(i)"
                  (mouseleave)="setHover(0)"
                  [class.filled]="i <= (hoverRating || selectedRating)">
          {{ getStarIcon(i) }}
        </mat-icon>
      </div>
    </div>
  </ng-container>

  <mat-divider></mat-divider>

  <!-- All Comments Header -->
  <div class="comments-header">
    <h3>All Comments <span class="comment-count">/{{ (comments$ | async)?.length || 0 }}</span></h3>
    <div class="sort-buttons">
      <button mat-button [class.active]="(sortBy$ | async) === 'newest'" (click)="setSort('newest')">Newest</button>
      <button mat-button [class.active]="(sortBy$ | async) === 'hottest'" (click)="setSort('hottest')">Hottest</button>
    </div>
  </div>

  <!-- Comments List -->
  <div class="comments-list">
    <div class="comment-item" *ngFor="let comment of comments$ | async">
      <div class="comment-avatar">
        <mat-icon>account_circle</mat-icon>
      </div>
      <div class="comment-content">
        <div class="comment-header-row">
          <span class="author-name" [routerLink]="['/users', comment.authorId]" style="cursor: pointer">{{ comment.authorName || 'User' }}</span>
          <span class="comment-stars">
            <mat-icon *ngFor="let star of getDisplayStars(comment.rating)"
                      [class.filled]="star === 1" class="mini-star">
              {{ star === 1 ? 'star' : 'star_border' }}
            </mat-icon>
          </span>
          <span class="comment-date">{{ comment.createdAt.toDate() | date:'yyyy-MM-dd' }}</span>
        </div>
        <p class="comment-text">{{ comment.text }}</p>

        <!-- Replies Display -->
        <div class="replies-list" *ngIf="comment.replies && comment.replies.length > 0">
          <div class="reply-item" *ngFor="let reply of getVisibleReplies(comment)">
            <div class="reply-avatar">
              <img [src]="reply.authorAvatar || 'assets/default-avatar.png'" alt="Avatar">
            </div>
            <div class="reply-content-wrapper">
              <div class="reply-header">
                <span class="reply-author" [routerLink]="['/users', reply.authorId]" style="cursor: pointer">{{ reply.authorName }}</span>
                <span class="reply-target" *ngIf="reply.replyToName">
                  <span class="reply-arrow">replied to</span> {{ reply.replyToName }}
                </span>
                <span class="reply-date">{{ reply.createdAt.toDate() | date:'MM-dd' }}</span>
              </div>
              <div class="reply-text">{{ reply.text }}</div>
              <div class="reply-actions">
                <button class="reply-action-btn" (click)="likeReply(comment.id!, reply)">
                  <mat-icon>thumb_up_off_alt</mat-icon> {{ reply.likes || 0 }}
                </button>
                <button class="reply-action-btn" (click)="initiateReplyToUser(comment.id!, reply.authorName)">
                  <mat-icon>chat_bubble_outline</mat-icon> Reply
                </button>
              </div>
            </div>
          </div>

          <div class="expand-replies" *ngIf="comment.replies.length > 1">
            <button mat-button color="primary" (click)="toggleExpandReplies(comment.id!)">
              {{ isExpanded(comment.id!) ? 'Collapse replies' : 'View all ' + comment.replies.length + ' replies' }}
            </button>
          </div>
        </div>

        <div class="comment-actions">
          <button mat-button class="action-btn" (click)="likeComment(comment)">
            <mat-icon>thumb_up</mat-icon> Like {{ comment.likes || 0 }}
          </button>
          <button mat-button class="action-btn" (click)="toggleReply(comment.id!)">
            <mat-icon>reply</mat-icon> Reply
          </button>
          <button mat-button class="action-btn delete-btn" *ngIf="canDeleteComment(comment)" (click)="deleteComment(comment)">
            <mat-icon>delete</mat-icon> Delete
          </button>
        </div>

        <!-- Reply Input -->
        <div class="reply-input-area" *ngIf="replyingToCommentId === comment.id">
          <div class="reply-box">
            <div class="reply-context" *ngIf="replyingToUserName">
              <span>Replying to {{ replyingToUserName }}</span>
              <button mat-icon-button class="close-context" (click)="replyingToUserName = null">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <textarea matInput [placeholder]="replyingToUserName ? 'Reply to ' + replyingToUserName + '...' : 'Reply to ' + (comment.authorName || 'User') + '...'" [(ngModel)]="replyText" rows="3"></textarea>
            <div class="reply-box-actions">
              <button mat-raised-button color="primary" (click)="submitReply(comment.id!)" [disabled]="!replyText.trim()">
                Post Reply
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="no-comments" *ngIf="(comments$ | async)?.length === 0">
      <mat-icon>forum</mat-icon>
      <p>No comments yet. Be the first to comment!</p>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Add Comment Form - Always visible -->
  <div class="add-comment-form">
    <div class="form-rating" [class.selected]="selectedRating > 0">
      <span *ngIf="selectedRating === 0">Please rate first:</span>
      <span *ngIf="selectedRating > 0">Your rating: {{ selectedRating }} stars</span>

      <div class="star-picker-small">
        <mat-icon *ngFor="let i of [1,2,3,4,5]"
                  (click)="setRating(i)"
                  (mouseenter)="setHover(i)"
                  (mouseleave)="setHover(0)"
                  [class.filled]="i <= (hoverRating || selectedRating)"
                  class="small-star">
          {{ (i <= (hoverRating || selectedRating)) ? 'star' : 'star_border' }}
        </mat-icon>
      </div>
    </div>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Share your thoughts...</mat-label>
      <textarea matInput [(ngModel)]="newCommentText" rows="3" placeholder="Write a comment..."></textarea>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="addComment()"
            [disabled]="!newCommentText.trim() || selectedRating === 0">
      Post Comment
    </button>
  </div>
</div>